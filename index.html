<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Assistente AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b0c10; color:#fff; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 24px; }
    h1 { margin:0 0 10px; font-size: clamp(20px,4vw,32px); text-align:center; }
    video { width:100%; background:#000; border-radius:12px; display:block; }
    .status { margin-top:8px; color:#9aa0a6; font-size:14px; text-align:center; }

    /* Contenitore chat + rail */
    .chat-wrap {
      position: relative;
      margin-top: 16px;
      height: 420px;
      border: 1px solid #15181d;
      border-radius: 12px;
      background: #0f1115;
      padding-right: 18px;          /* spazio per la rail */
      box-sizing: border-box;       /* include padding/border nell'altezza */
    }

    /* Chat ancorata in basso (no overflow) */
    .chat {
      height: 100%;
      box-sizing: border-box;       /* evita che il padding faccia “uscire” i contenuti */
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;    /* ultimi messaggi in basso */
      text-align: left;
      padding: 10px;
      gap: 8px;
      scrollbar-width: none;        /* Firefox: nasconde scrollbar nativa */
    }
    .chat::-webkit-scrollbar { display: none; } /* WebKit: nasconde scrollbar nativa */

    .msg {
      display: inline-flex;
      max-width: 85%;
      padding: 10px 12px;
      border-radius: 12px;
      white-space: pre-wrap;
      line-height: 1.35;
      word-wrap: break-word;
    }
    .msg.user {
      align-self: flex-end;
      background: #1a73e8;
      color: #fff;
      border-bottom-right-radius: 6px;
    }
    .msg.assistant {
      align-self: flex-start;
      background: #0b0c10;
      color: #e3e3e3;
      border: 1px solid #15181d;
      border-bottom-left-radius: 6px;
    }

    .log { margin-top:8px; font-size:14px; color:#9aa0a6; min-height:18px; text-align:left; }

    /* Rail/slider personalizzato */
    .rail {
      position: absolute;
      top: 10px;
      right: 6px;
      bottom: 10px;
      width: 8px;
      background: #0b0c10;
      border: 1px solid #15181d;
      border-radius: 999px;
      opacity: 0.9;
      user-select: none;
      display: none; /* si mostra solo quando serve (via JS) */
    }
    .handle {
      position: absolute;
      left: -1px;                /* leggero overdraw per coprire bordo rail */
      width: 10px;
      height: 40px;              /* ricalcolata via JS */
      background: #2b98f0;
      border-radius: 999px;
      border: 2px solid #0f1115;
      box-sizing: border-box;
      cursor: grab;
    }
    .handle:active { cursor: grabbing; }
    .noselect { user-select: none; }

    /* Riga input sotto la chat */
    .row { display:flex; gap:8px; margin-top:12px; }
    input { flex:1; padding:12px; border-radius:10px; border:0; background:#0f1115; color:#fff; }
    button { padding:12px 16px; border-radius:10px; border:0; background:#5ac8fa; color:#001018; font-weight:600; cursor:pointer; }
    button[disabled] { opacity:0.6; cursor:not-allowed; }

    @media (max-width: 640px) {
      .row { flex-direction: column; }
      button { width:100%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Assistente AI</h1>

    <!-- Video avatar (nascosto finché non c’è token HeyGen) -->
    <video id="avatarVideo" autoplay playsinline muted style="display:none"></video>
    <div id="status" class="status">Modalità chat testuale (avatar non ancora configurato).</div>

    <!-- CHAT + SLIDER -->
    <div class="chat-wrap">
      <div id="chat" class="chat" aria-live="polite" aria-label="Conversazione"></div>
      <div class="rail" id="rail"><div class="handle" id="handle"></div></div>
    </div>
    <div id="log" class="log"></div>

    <!-- INPUT -->
    <div class="row">
      <input id="q" placeholder="Scrivi qui la tua domanda in italiano…" autocomplete="off" />
      <button id="ask">Invia</button>
    </div>
  </div>

  <script type="module">
    const API_BASE = ''; // percorsi relativi

    const $ = id => document.getElementById(id);
    const statusEl = $("status"), logEl = $("log"), videoEl = $("avatarVideo");
    const askBtn = $("ask"), qEl = $("q"), chatEl = $("chat");
    const railEl = $("rail"), handleEl = $("handle");
    const history = [];

    // Avatar opzionale (si attiverà con HEYGEN_API_KEY su Vercel)
    const MAX_SESSION_MS = 9 * 60 * 1000;
    let StreamingAvatar, StreamingEvents, avatar = null, startedAt = 0, rotateTimer;

    async function loadSDK() {
      ({ default: StreamingAvatar, StreamingEvents } =
        await import("https://unpkg.com/@heygen/streaming-avatar/dist/index.js"));
    }

    async function initAvatarIfAvailable() {
      try {
        const r = await fetch(`${API_BASE}/api/get-heygen-token`, { method: "POST" });
        const j = await r.json();
        if (!r.ok || !j?.token) throw new Error("no_token");

        await loadSDK();
        avatar = new StreamingAvatar({ token: j.token });

        avatar.on(StreamingEvents.STREAM_READY, (e) => {
          videoEl.srcObject = e.detail;
          videoEl.style.display = "block";
          videoEl.addEventListener('click', () => { videoEl.muted = false; }, { once:true });
          videoEl.play();
          statusEl.textContent = "Avatar pronto. Fai una domanda.";
          startedAt = Date.now();
          rotateTimer && clearInterval(rotateTimer);
          rotateTimer = setInterval(rotateIfNeeded, 10000);
        });
        avatar.on(StreamingEvents.STREAM_DISCONNECTED, restartAvatar);
        avatar.on(StreamingEvents.ERROR, restartAvatar);

        await avatar.createStartAvatar({ quality: "high" });
      } catch {
        videoEl.style.display = "none";
        statusEl.textContent = "Modalità chat testuale (avatar non ancora configurato).";
      }
    }

    async function rotateIfNeeded() {
      if (!avatar) return;
      if (Date.now() - startedAt < MAX_SESSION_MS) return;
      await restartAvatar();
    }
    async function restartAvatar() {
      try { if (avatar?.stopAvatar) await avatar.stopAvatar(); if (avatar?.stop) await avatar.stop(); } catch {}
      await initAvatarIfAvailable();
    }

    // --- CHAT UI ---
    function addMessage(role, text) {
      const el = document.createElement("div");
      el.className = `msg ${role}`;
      el.textContent = text;
      chatEl.appendChild(el);
      chatEl.scrollTop = chatEl.scrollHeight; // resta ancorata in basso
      updateHandle();                          // aggiorna slider
    }

    async function sendMessage() {
      const msg = qEl.value.trim();
      if (!msg) return;

      qEl.value = "";
      askBtn.disabled = true;
      askBtn.textContent = "Invio…";
      logEl.textContent = "Chiedo al modello…";

      history.push({ role: "user", content: msg });
      addMessage("user", msg);

      try {
        const r = await fetch(`${API_BASE}/api/chat`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: msg, history: history.slice(-6) })
        });

        if (!r.ok) {
          const t = await r.text().catch(()=>"(no body)");
          logEl.textContent = `Errore API: ${r.status} ${t}`;
          return;
        }

        const { answer } = await r.json();
        history.push({ role: "assistant", content: answer });
        addMessage("assistant", answer);
        logEl.textContent = "";

        if (avatar) { try { await avatar.speak({ text: answer }); } catch {} }
      } catch (e) {
        logEl.textContent = `Errore di rete: ${e?.message || e}`;
      } finally {
        askBtn.disabled = false;
        askBtn.textContent = "Invia";
      }
    }

    askBtn.addEventListener("click", sendMessage);
    qEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    });
    qEl.setAttribute("enterkeyhint", "send");
    qEl.setAttribute("autocomplete", "off");

    // --- SLIDER PERSONALIZZATO ---
    function updateHandle() {
      const el = chatEl;
      const visible = el.clientHeight;      // include padding grazie a border-box
      const total = el.scrollHeight;
      const ratio = Math.min(1, visible / Math.max(1, total));
      const handleH = Math.max(40, Math.floor(visible * ratio));
      handleEl.style.height = handleH + 'px';

      const maxScroll = Math.max(0, total - visible);
      const maxTop = Math.max(0, visible - handleH);
      const top = maxScroll ? (el.scrollTop / maxScroll) * maxTop : 0;
      handleEl.style.top = top + 'px';

      railEl.style.display = (total <= visible) ? 'none' : 'block';
    }

    chatEl.addEventListener('scroll', updateHandle);
    window.addEventListener('resize', updateHandle);

    // Drag
    let dragging = false, startY = 0, startTop = 0;
    handleEl.addEventListener('mousedown', (e) => {
      dragging = true;
      startY = e.clientY;
      startTop = parseInt(handleEl.style.top || '0', 10) || 0;
      document.body.classList.add('noselect');
      e.preventDefault();
    });
    window.addEventListener('mousemove', (e) => {
      if (!dragging) return;
      const el = chatEl;
      const visible = el.clientHeight;
      const total = el.scrollHeight;
      const handleH = handleEl.offsetHeight;
      const maxTop = Math.max(0, visible - handleH);

      let newTop = startTop + (e.clientY - startY);
      newTop = Math.max(0, Math.min(maxTop, newTop));
      handleEl.style.top = newTop + 'px';

      const maxScroll = Math.max(0, total - visible);
      const newScroll = maxTop ? (newTop / maxTop) * maxScroll : 0;
      el.scrollTop = newScroll;
    });
    window.addEventListener('mouseup', () => {
      if (dragging) {
        dragging = false;
        document.body.classList.remove('noselect');
      }
    });

    // Ping diagnostico: GET /api/chat deve dare 405
    (async () => {
      try {
        const ping = await fetch(`${API_BASE}/api/chat`, { method: "GET" });
        if (ping.status !== 405) console.warn("Ping /api/chat atteso 405, ottenuto:", ping.status);
      } catch (e) {
        statusEl.textContent = "Errore di rete verso l'API. Ricarica la pagina su questo dominio.";
      }
    })();

    // Avvio
    initAvatarIfAvailable();
    // Delay minimo per assicurare layout stabile prima del calcolo slider
    requestAnimationFrame(updateHandle);
  </script>
</body>
</html>
