<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Niccolò Musmeci</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b0c10; --panel:#0f1115; --text:#e6e6e6; --muted:#9aa0a6; --accent:#5ac8fa; --me:#1f6feb; --you:#2a2f3a; --border:#1c1f26; }
    html,body { height:100%; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width:980px; margin:0 auto; padding:20px; }
    h1 { margin:0 0 4px; font-size:clamp(20px,4vw,30px); font-weight:650; }
    .sub { color:var(--muted); margin-bottom:10px; }
    .ver { color:#7a838f; font-size:12px; margin-bottom:14px; }

    .video-wrap { position: relative; background:#000; border:1px solid var(--border); border-radius:12px; overflow:hidden; aspect-ratio:16/9; min-height:220px; }
    video { display:none; width:100%; height:auto; background:#000; }
    .avatar-placeholder { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#9aa0a6; font-size:14px; text-align:center; padding:0 12px; }
    #status { margin:10px 0 16px; color:var(--muted); font-size:14px; }

    .panel { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px; }
    .chat-shell { display:flex; flex-direction:column; gap:12px; }
    #chat { height:min(52vh,420px); overflow-y:auto; padding:6px; display:flex; flex-direction:column; gap:10px; border-radius:10px; scrollbar-color:#2b3342 #0c0e13; scrollbar-width:thin; }
    #chat::-webkit-scrollbar { width:10px; } #chat::-webkit-scrollbar-track { background:#0c0e13; border-radius:10px; } #chat::-webkit-scrollbar-thumb { background:#2b3342; border-radius:10px; }
    .msg { max-width:78%; padding:10px 12px; border-radius:12px; line-height:1.35; font-size:15px; white-space:pre-wrap; word-wrap:break-word; }
    .msg.user { align-self:flex-end; background:var(--me); color:#fff; border-bottom-right-radius:6px; }
    .msg.assistant { align-self:flex-start; background:var(--you); color:#eaecef; border-bottom-left-radius:6px; }
    .time { display:block; margin-top:6px; color:#b1b7c0; font-size:12px; }
    .composer { display:flex; gap:8px; align-items:center; }
    input#q { flex:1; padding:12px; border-radius:10px; border:1px solid var(--border); background:#0d1016; color:#fff; }
    button { padding:12px 16px; border-radius:10px; border:0; background:var(--accent); color:#001018; font-weight:600; cursor:pointer; }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    .muted { color:var(--muted); font-size:13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Niccolò Musmeci</h1>
    <div class="sub">Assistente alla privacy per il sistema ospedaliero italiano</div>
    <div class="ver">build: 2025-12-12 23:10</div>

    <div class="video-wrap">
      <video id="avatarVideo" autoplay playsinline muted></video>
      <div id="avatarPh" class="avatar-placeholder">Avatar non configurato (in attesa token). La chat testuale è attiva.</div>
    </div>
    <div id="status">Modalità chat testuale (avatar non configurato).</div>

    <div class="panel">
      <div class="chat-shell">
        <div id="chat" aria-live="polite" aria-label="Conversazione"></div>
        <div class="composer">
          <input id="q" placeholder="Scrivi qui la tua domanda in italiano…" autocomplete="off" />
          <button id="ask">Invia</button>
        </div>
        <div id="log" class="muted"></div>
      </div>
    </div>
  </div>

<script type="importmap">
{
  "imports": {
    "livekit-client": "https://cdn.jsdelivr.net/npm/livekit-client@2.16.1/dist/livekit-client.esm.mjs",
    "protobufjs": "https://esm.sh/protobufjs@7",
    "protobufjs/minimal": "https://esm.sh/protobufjs@7/minimal",
    "tslib": "https://cdn.jsdelivr.net/npm/tslib@2.6.2/tslib.es6.js"
  }
}
</script>
  
<script type="module">
  const API_BASE = ""; // usa percorsi relativi (/api/*)

  // ID avatar/voce HeyGen (puoi lasciare vuoto l’avatar per il primo test)
  const HEYGEN_AVATAR_ID = "cb58c4a7e64e4f849b621df9a2aecb0b";            // es. "avtr_XXXXXXXX"
  const HEYGEN_VOICE_ID  = "";            // opzionale

  // Riferimenti UI
  const $ = id => document.getElementById(id);
  const statusEl = $("status"), logEl = $("log"), videoEl = $("avatarVideo");
  const askBtn = $("ask"), qEl = $("q"), chatEl = $("chat");

  // Stato chat e avatar
  const history = [];
  const MAX_SESSION_MS = 9 * 60 * 1000;
  let StreamingAvatar, StreamingEvents, avatar = null, startedAt = 0, rotateTimer;

  function setPh(msg) {
    const ph = document.getElementById("avatarPh");
    if (ph) ph.textContent = msg;
    console.log("[DTI/Avatar]", msg);
  }

  // Carico l’SDK HeyGen (ESM) – richiede l’IMPORT MAP in <head> per livekit-client/protobufjs/tslib
  async function loadSDK() {
    if (StreamingAvatar && StreamingEvents) return;
    const mod = await import('https://cdn.jsdelivr.net/npm/@heygen/streaming-avatar@2.1.0/lib/index.esm.js');
    StreamingAvatar = mod.default;
    StreamingEvents  = mod.StreamingEvents;
    console.log("[DTI/Avatar] SDK ESM caricato");
  }

  async function initAvatarIfAvailable() {
    try {
      setPh("Richiesta token…");
      const r = await fetch(`${API_BASE}/api/get-heygen-token`, { method: "POST" });
      const j = await r.json();
      if (!r.ok || !j?.token) throw new Error((j && j.error) || "no_token");
      setPh("Token OK. Carico SDK…");

      await loadSDK();
      setPh("SDK OK. Creo lo stream…");

      avatar = new StreamingAvatar({ token: j.token });

      avatar.on(StreamingEvents.STREAM_READY, (e) => {
        console.log("[DTI/Avatar] STREAM_READY");
        const ph = document.getElementById("avatarPh");
        if (ph) ph.style.display = "none";
        videoEl.srcObject = e.detail;
        videoEl.style.display = "block";
        // primo click sblocca l’audio per policy browser
        videoEl.addEventListener("click", () => { videoEl.muted = false; }, { once: true });
        videoEl.play();
        statusEl.textContent = "Avatar pronto. Fai una domanda.";
        startedAt = Date.now();
        
        // rinnovo prima dei 10'
        rotateTimer && clearInterval(rotateTimer);
        rotateTimer = setInterval(() => {
          if (Date.now() - startedAt > MAX_SESSION_MS) restartAvatar();
        }, 10_000);
        avatar.speak({ text: "Ciao! Dimmi pure la tua domanda." });  // <— TEST: deve animare bocca

      });

      avatar.on(StreamingEvents.STREAM_DISCONNECTED, (e) => {
        console.warn("[DTI/Avatar] STREAM_DISCONNECTED", e);
        setPh("Connessione interrotta. Riavvio…");
        restartAvatar();
      });

      avatar.on(StreamingEvents.ERROR, (e) => {
        const d = e?.detail || {};
        const code = d.code || d.status || "";
        const msg  = d.message || d.error || (typeof e === "string" ? e : "");
        console.error("[DTI/Avatar] STREAM_ERROR", d);
        setPh(`Errore streaming${code ? " "+code : ""}: ${msg || "unknown_error"}`);
        restartAvatar();
      });

      // >>> QUI: startOpts DENTRO la init, subito prima dello start <<<
      const startOpts = { quality: "low", language: "it" };  // “low” per test, poi “high”

// usa l’ID che hai copiato da HeyGen
if (HEYGEN_AVATAR_ID) {
  startOpts.avatarName = HEYGEN_AVATAR_ID;   // ← parametro corretto per lo streaming SDK
  // startOpts.avatarId = HEYGEN_AVATAR_ID;  // (legacy) solo se stai usando una demo vecchia
}

console.log("[DTI/Avatar] createStartAvatar opts", startOpts);
await avatar.createStartAvatar(startOpts);

      // attendo STREAM_READY
    } catch (err) {
      const d = err?.detail || err;
      const code = d?.code || d?.status || "";
      const msg  = d?.message || d?.error || (typeof err === "string" ? err : "");
      console.error("[DTI/Avatar] init error", d);
      statusEl.textContent = "Modalità chat testuale (avatar non configurato).";
      setPh(`Errore avatar${code ? " "+code : ""}: ${msg || "init_failed"}`);
    }
  }

  async function restartAvatar() {
    try { if (avatar?.stopAvatar) await avatar.stopAvatar(); if (avatar?.stop) await avatar.stop(); } catch {}
    await initAvatarIfAvailable();
  }

  // ===== Chat testuale =====
  function now() { return new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' }); }
  function appendMsg(role, text) {
    const b = document.createElement("div");
    b.className = `msg ${role}`;
    b.textContent = text;
    const t = document.createElement("span");
    t.className = "time"; t.textContent = now();
    b.appendChild(t);
    chatEl.appendChild(b);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  qEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); askBtn.click(); }
  });

  askBtn.addEventListener("click", async () => {
    const msg = qEl.value.trim();
    if (!msg) return;
    qEl.value = ""; askBtn.disabled = true; logEl.textContent = "Sto chiedendo al DTI…";

    history.push({ role: "user", content: msg }); appendMsg("user", msg);
    try {
      const r = await fetch(`${API_BASE}/api/chat`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: msg, history: history.slice(-6) })
      });
      const { answer } = await r.json();
      const safe = (answer || "").toString().trim() || "Non ho una risposta in questo momento.";
      history.push({ role: "assistant", content: safe }); appendMsg("assistant", safe); logEl.textContent = "";

      if (avatar) { try { await avatar.speak({ text: safe }); } catch (e) { console.warn("speak error", e); } }
    } catch {
      logEl.textContent = "Errore nel recupero della risposta. Riprova.";
    } finally { askBtn.disabled = false; qEl.focus(); }
  });

  // Avvio avatar (se token/SDK ok)
  initAvatarIfAvailable();
</script>
</body>
</html>
