<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Avatar + Chat (Chatbase)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family: system-ui, sans-serif; background:#0b0c10; color:#fff; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 24px; text-align: center; }
    h1 { margin:0 0 10px; font-size: clamp(20px,4vw,32px); }
    video { width:100%; background:#000; border-radius:12px; display:block; }
    .row { display:flex; gap:8px; margin-top:12px; }
    input { flex:1; padding:12px; border-radius:10px; border:0; background:#0f1115; color:#fff; }
    button { padding:12px 16px; border-radius:10px; border:0; background:#5ac8fa; color:#001018; font-weight:600; cursor:pointer; }
    .status { margin-top:8px; color:#9aa0a6; font-size:14px; }
    .log { margin-top:10px; font-size:14px; color:#9aa0a6; min-height:20px; text-align:left; }
     .chat {
  margin-top: 12px;
  max-height: 420px;       /* regola se vuoi più/meno spazio */
  overflow: auto;
  text-align: left;
  padding-right: 4px;
}
.msg {
  display: inline-block;
  max-width: 85%;
  margin: 6px 0;
  padding: 10px 12px;
  border-radius: 12px;
  white-space: pre-wrap;   /* conserva a capo */
  line-height: 1.35;
}
.msg.user {
  background: #1a73e8;
  color: #fff;
  align-self: flex-end;
  float: right;
  clear: both;
  border-bottom-right-radius: 6px;
}
.msg.assistant {
  background: #0f1115;
  color: #e3e3e3;
  float: left;
  clear: both;
  border-bottom-left-radius: 6px;
}

  </style>
</head>
<body>
  <div class="wrap">
    <h1>Lawy</h1>
    <video id="avatarVideo" autoplay playsinline muted></video>
    <div id="status" class="status">Connessione all’avatar…</div>

   
    
<div class="row">
      <input id="q" placeholder="Scrivi qui la tua domanda in italiano…" />
      <button id="ask">Invia</button>
    </div>

    <div id="chat" class="chat" aria-live="polite" aria-label="Conversazione"></div>
<div id="log" class="log"></div>

const $ = id => document.getElementById(id);
const statusEl = $("status"), logEl = $("log"), videoEl = $("avatarVideo");
const askBtn = $("ask"), qEl = $("q");
const chatEl = $("chat");                 // <<— nuovo
const history = [];

// append di un messaggio nella chat
function addMessage(role, text) {
  const el = document.createElement("div");
  el.className = `msg ${role}`;
  el.textContent = text;                  // sicuro (niente HTML)
  chatEl.appendChild(el);
  // scroll in basso
  chatEl.scrollTop = chatEl.scrollHeight;
}

// funzione centralizzata di invio
async function sendMessage() {
  const msg = qEl.value.trim();
  if (!msg) return;

  // UI
  qEl.value = "";
  askBtn.disabled = true;
  askBtn.textContent = "Invio…";
  logEl.textContent = "Chiedo al modello…";

  // aggiorna stato locale + UI chat
  history.push({ role: "user", content: msg });
  addMessage("user", msg);

  try {
    const r = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: msg, history: history.slice(-6) })
    });

    if (!r.ok) {
      const t = await r.text().catch(()=>"(no body)");
      logEl.textContent = `Errore API: ${r.status} ${t}`;
      return;
    }

    const { answer } = await r.json();
    history.push({ role: "assistant", content: answer });
    addMessage("assistant", answer);      // <<— appende, non sovrascrive
    logEl.textContent = "";               // pulisci stato

    if (avatar) {
      try { await avatar.speak({ text: answer }); } catch {}
    }
  } catch (e) {
    logEl.textContent = `Errore di rete: ${e?.message || e}`;
  } finally {
    askBtn.disabled = false;
    askBtn.textContent = "Invia";
  }
}

// click sul bottone
askBtn.addEventListener("click", sendMessage);

// Enter sulla tastiera
qEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    sendMessage();
  }
});

      

// (facoltativo) migliore UX su mobile: tasto invio “Invia”
qEl.setAttribute("enterkeyhint", "send");
qEl.setAttribute("autocomplete", "off");


  // Avvio
  initAvatarIfAvailable();
</script>
